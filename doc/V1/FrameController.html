<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: V1::FrameController
  
    &mdash; Documentation by YARD 0.7.5
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '..';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (F)</a> &raquo; 
    <span class='title'>V1</span>
     &raquo; 
    <span class="title">FrameController</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a id="class_list_link" href="#">Class List</a>
  
    <a id="method_list_link" href="#">Method List</a>
  
    <a id="file_list_link" href="#">File List</a>
  
</div>
      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: V1::FrameController
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">ApplicationController</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">ApplicationController</li>
          
            <li class="next">V1::FrameController</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">app/controllers/v1/frame_controller.rb</dd>
  
</dl>
<div class="clear"></div>








  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_to_watch_later-instance_method" title="#add_to_watch_later (instance method)">- (Object) <strong>add_to_watch_later</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Adds a dupe of the given Frame to the logged in users watch_later_roll and
returns the dupe Frame.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#create-instance_method" title="#create (instance method)">- (Object) <strong>create</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Creates and returns one frame, with the given parameters.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#destroy-instance_method" title="#destroy (instance method)">- (Integer) <strong>destroy</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Destroys one frame, returning Success/Failure.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#index-instance_method" title="#index (instance method)">- (Object) <strong>index</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns all frames in a roll.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#share-instance_method" title="#share (instance method)">- (Object) <strong>share</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns success if frame is shared successfully, with the given parameters.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#show-instance_method" title="#show (instance method)">- (Object) <strong>show</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns one frame.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#upvote-instance_method" title="#upvote (instance method)">- (Object) <strong>upvote</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Upvotes a frame and returns the frame back w new score.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#watched-instance_method" title="#watched (instance method)">- (Object) <strong>watched</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>For logged in user, update their viewed_roll and view_count on Frame and
Video (once per 24 hours per user) For logged in and non-logged in user,
create a UserAction to track this portion of viewing.</p>
</div></span>
  
</li>

      
    </ul>
  


  

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="add_to_watch_later-instance_method">
  
    - (<tt>Object</tt>) <strong>add_to_watch_later</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Adds a dupe of the given Frame to the logged in users watch_later_roll and
returns the dupe Frame</p>

<pre class="code ruby"><code><span class='const'>REQUIRES</span> <span class='const'>AUTHENTICATION</span></code></pre>
<dl class="rdoc-list"><dt>POST</dt>
<dd>
<p>/v1/frame/:id/add_to_watch_later</p>
</dd></dl>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>id</span>
      
      
        <span class='type'>(<tt>Required</tt>, <tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The id of the frame</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/v1/frame_controller.rb', line 322</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_to_watch_later'>add_to_watch_later</span>
  <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_time'>time</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_api'>api</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>frame</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>add_to_watch_later</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:frame_id</span><span class='rbracket'>]</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>please specify a valid id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='lparen'>(</span><span class='id identifier rubyid_frame_id'>frame_id</span> <span class='op'>=</span> <span class='id identifier rubyid_ensure_valid_bson_id'>ensure_valid_bson_id</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:frame_id</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='rparen'>)</span>
      
      <span class='ivar'>@frame</span> <span class='op'>=</span> <span class='const'>Frame</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:frame_id</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='ivar'>@new_frame</span> <span class='op'>=</span> <span class='ivar'>@frame</span><span class='period'>.</span><span class='id identifier rubyid_add_to_watch_later!'>add_to_watch_later!</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='rparen'>)</span>
        <span class='ivar'>@status</span> <span class='op'>=</span> <span class='int'>200</span>
        <span class='const'>GT</span><span class='op'>::</span><span class='const'>UserActionManager</span><span class='period'>.</span><span class='id identifier rubyid_watch_later!'>watch_later!</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='ivar'>@frame</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
        <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_increment'>increment</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_frame'>frame</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>watch_later</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>frame_watch_later</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>could not find frame</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="create-instance_method">
  
    - (<tt>Object</tt>) <strong>create</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Creates and returns one frame, with the given parameters.</p>

<pre class="code ruby"><code><span class='const'>REQUIRES</span> <span class='const'>AUTHENTICATION</span></code></pre>
<dl class="rdoc-list"><dt>POST</dt>
<dd>
<p>/v1/roll/:roll_id/frames</p>
</dd></dl>

<p>If trying to re-roll: If trying to add a frame via a url:</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>frame_id</span>
      
      
        <span class='type'>(<tt>Required</tt>, <tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A frame to be re_rolled</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>url</span>
      
      
        <span class='type'>(<tt>Required</tt>, <tt>Escaped String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A video url</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>text</span>
      
      
        <span class='type'>(<tt>Optional</tt>, <tt>Escaped String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Message text to via added to the conversation</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>source</span>
      
      
        <span class='type'>(<tt>Optional</tt>, <tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The source could be bookmarklet, webapp, etc</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/v1/frame_controller.rb', line 152</span>

<span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>
  <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_time'>time</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_api'>api</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>frame</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>create</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>this route is for jsonp only.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_get?'>get?</span> <span class='kw'>and</span> <span class='op'>!</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:callback</span><span class='rbracket'>]</span>
    
    <span class='id identifier rubyid_roll'>roll</span> <span class='op'>=</span> <span class='const'>Roll</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:roll_id</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>could not find that roll</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_roll'>roll</span>
    
    <span class='comment'># create frame from a video url
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_video_url'>video_url</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:url</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_frame_options'>frame_options</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:creator</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='comma'>,</span> <span class='symbol'>:roll</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_roll'>roll</span> <span class='rbrace'>}</span>
      <span class='comment'># get or create video from url
</span>      <span class='id identifier rubyid_frame_options'>frame_options</span><span class='lbracket'>[</span><span class='symbol'>:video</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>GT</span><span class='op'>::</span><span class='const'>VideoManager</span><span class='period'>.</span><span class='id identifier rubyid_get_or_create_videos_for_url'>get_or_create_videos_for_url</span><span class='lparen'>(</span><span class='id identifier rubyid_video_url'>video_url</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>
      
      <span class='comment'># create message
</span>      <span class='id identifier rubyid_message_text'>message_text</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:text</span><span class='rbracket'>]</span> <span class='op'>?</span> <span class='const'>CGI</span><span class='op'>::</span><span class='id identifier rubyid_unescape'>unescape</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:text</span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_frame_options'>frame_options</span><span class='lbracket'>[</span><span class='symbol'>:message</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>GT</span><span class='op'>::</span><span class='const'>MessageManager</span><span class='period'>.</span><span class='id identifier rubyid_build_message'>build_message</span><span class='lparen'>(</span><span class='symbol'>:user</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='comma'>,</span> <span class='symbol'>:public</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='symbol'>:text</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_message_text'>message_text</span><span class='rparen'>)</span>
      
      <span class='comment'># set the action, defaults to new_bookmark_frame
</span>      <span class='kw'>case</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:source</span><span class='rbracket'>]</span>
      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bookmark</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
        <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_increment'>increment</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_frame'>frame</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>create</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bookmarklet</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>frame_create_bookmarklet</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_frame_options'>frame_options</span><span class='lbracket'>[</span><span class='symbol'>:action</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>DashboardEntry</span><span class='op'>::</span><span class='const'>ENTRY_TYPE</span><span class='lbracket'>[</span><span class='symbol'>:new_bookmark_frame</span><span class='rbracket'>]</span>
      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>extension</span><span class='tstring_end'>&quot;</span></span>
        <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_increment'>increment</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_frame'>frame</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>create</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>extionsion</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>frame_create_extension</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_frame_options'>frame_options</span><span class='lbracket'>[</span><span class='symbol'>:action</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>DashboardEntry</span><span class='op'>::</span><span class='const'>ENTRY_TYPE</span><span class='lbracket'>[</span><span class='symbol'>:new_bookmark_frame</span><span class='rbracket'>]</span>
      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>webapp</span><span class='tstring_end'>&quot;</span></span>
        <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_increment'>increment</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_frame'>frame</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>create</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>webapp</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>frame_create_inapp</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_frame_options'>frame_options</span><span class='lbracket'>[</span><span class='symbol'>:action</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>DashboardEntry</span><span class='op'>::</span><span class='const'>ENTRY_TYPE</span><span class='lbracket'>[</span><span class='symbol'>:new_in_app_frame</span><span class='rbracket'>]</span>
      <span class='kw'>else</span>
        <span class='kw'>return</span> <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>that action isn't cool.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      
      <span class='comment'># only allow roll creation if user is authorized to access the given roll
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_roll'>roll</span><span class='period'>.</span><span class='id identifier rubyid_postable_by?'>postable_by?</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='rparen'>)</span>
        <span class='comment'># and finally create the frame
</span>        <span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='id identifier rubyid_frame_options'>frame_options</span><span class='lbracket'>[</span><span class='symbol'>:video</span><span class='rbracket'>]</span> <span class='op'>?</span> <span class='const'>GT</span><span class='op'>::</span><span class='const'>Framer</span><span class='period'>.</span><span class='id identifier rubyid_create_frame'>create_frame</span><span class='lparen'>(</span><span class='id identifier rubyid_frame_options'>frame_options</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>

        <span class='kw'>if</span> <span class='ivar'>@frame</span> <span class='op'>=</span> <span class='id identifier rubyid_r'>r</span><span class='lbracket'>[</span><span class='symbol'>:frame</span><span class='rbracket'>]</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='int'>200</span>          
        <span class='kw'>else</span>
          <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>something went wrong when creating that frame</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
        <span class='kw'>end</span>
        
      <span class='kw'>else</span>
        <span class='kw'>return</span> <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>403</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>that user cant post to that roll</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      
    <span class='comment'># create a new frame by re-rolling a frame from a frame_id
</span>    <span class='kw'>elsif</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:frame_id</span><span class='rbracket'>]</span> <span class='kw'>and</span> <span class='lparen'>(</span> <span class='id identifier rubyid_frame_to_re_roll'>frame_to_re_roll</span> <span class='op'>=</span> <span class='const'>Frame</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:frame_id</span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='rparen'>)</span>
      
      <span class='kw'>begin</span>
        <span class='comment'># only allow roll creation if user is authorized to access the given roll
</span>        <span class='kw'>if</span> <span class='id identifier rubyid_roll'>roll</span><span class='period'>.</span><span class='id identifier rubyid_postable_by?'>postable_by?</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='rparen'>)</span>
          <span class='ivar'>@frame</span> <span class='op'>=</span> <span class='id identifier rubyid_frame_to_re_roll'>frame_to_re_roll</span><span class='period'>.</span><span class='id identifier rubyid_re_roll'>re_roll</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='comma'>,</span> <span class='id identifier rubyid_roll'>roll</span><span class='rparen'>)</span>
          <span class='ivar'>@frame</span> <span class='op'>=</span> <span class='ivar'>@frame</span><span class='lbracket'>[</span><span class='symbol'>:frame</span><span class='rbracket'>]</span>
          <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_increment'>increment</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_frame'>frame</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>re_roll</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>frame_re_roll</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='rparen'>)</span>
          <span class='ivar'>@status</span> <span class='op'>=</span> <span class='int'>200</span>
        <span class='kw'>else</span>
          <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>403</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>that user cant post to that roll</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>could not re_roll: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      
    <span class='kw'>else</span>
      
      <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>you haven't built me to do anything else yet...</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="destroy-instance_method">
  
    - (<tt>Integer</tt>) <strong>destroy</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Destroys one frame, returning Success/Failure</p>

<pre class="code ruby"><code><span class='const'>REQUIRES</span> <span class='const'>AUTHENTICATION</span></code></pre>
<dl class="rdoc-list"><dt>DELETE</dt>
<dd>
<p>/v1/frame/:id</p>
</dd></dl>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>id</span>
      
      
        <span class='type'>(<tt>Required</tt>, <tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The id of the frame to destroy.</p>
</div>
      
    </li>
  
</ul>

<h3>Returns:</h3>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Whether request was successful or not.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


381
382
383
384
385
386
387
388
389
390
391
392
393
394</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/v1/frame_controller.rb', line 381</span>

<span class='kw'>def</span> <span class='id identifier rubyid_destroy'>destroy</span>
  <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_time'>time</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_api'>api</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>frame</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>destroy</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>please specify a valid id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='lparen'>(</span><span class='id identifier rubyid_frame_id'>frame_id</span> <span class='op'>=</span> <span class='id identifier rubyid_ensure_valid_bson_id'>ensure_valid_bson_id</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='rparen'>)</span>
      
      <span class='kw'>if</span> <span class='id identifier rubyid_frame'>frame</span> <span class='op'>=</span> <span class='const'>Frame</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_frame_id'>frame_id</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='id identifier rubyid_frame'>frame</span><span class='period'>.</span><span class='id identifier rubyid_destroy'>destroy</span> 
        <span class='ivar'>@status</span> <span class='op'>=</span> <span class='int'>200</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>could not find that frame to destroy</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_frame'>frame</span>
        <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>could not destroy that frame</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="index-instance_method">
  
    - (<tt>Object</tt>) <strong>index</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Returns all frames in a roll</p>

<pre class="code ruby"><code><span class='const'>AUTHENTICATION</span> <span class='const'>OPTIONAL</span></code></pre>
<dl class="rdoc-list"><dt>GET</dt>
<dd>
<p>/v1/roll/:id/frames</p>
</dd></dl>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>include_children</span>
      
      
        <span class='type'>(<tt>Optional</tt>, <tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>if true will return frame children</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>limit</span>
      
      
        <span class='type'>(<tt>Optional</tt>, <tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>limit the number of frames returned, default 20</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>skip</span>
      
      
        <span class='type'>(<tt>Optional</tt>, <tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the number of frames to skip, default 0</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>since_id</span>
      
      
        <span class='type'>(<tt>Optional</tt>, <tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the frame to start from</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>order</span>
      
      
        <span class='type'>(<tt>Optional</tt>, <tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>which way to go: 1, -1, forward, reverse (nil ok too)</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/v1/frame_controller.rb', line 21</span>

<span class='kw'>def</span> <span class='id identifier rubyid_index'>index</span>
  <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_time'>time</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_api'>api</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>frame</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>index</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='comment'># default params
</span>    <span class='ivar'>@limit</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:limit</span><span class='rbracket'>]</span> <span class='op'>?</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:limit</span><span class='rbracket'>]</span> <span class='op'>:</span> <span class='int'>20</span>
    <span class='comment'># put an upper limit on the number of entries returned
</span>    <span class='ivar'>@limit</span> <span class='op'>=</span> <span class='int'>20</span> <span class='kw'>if</span> <span class='ivar'>@limit</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>&gt;</span> <span class='int'>20</span>

    <span class='id identifier rubyid_skip'>skip</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:skip</span><span class='rbracket'>]</span> <span class='op'>?</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:skip</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>:</span> <span class='int'>0</span>
          
    <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:roll_id</span><span class='rbracket'>]</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>please specify a valid id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='lparen'>(</span><span class='id identifier rubyid_roll_id'>roll_id</span> <span class='op'>=</span> <span class='id identifier rubyid_ensure_valid_bson_id'>ensure_valid_bson_id</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:roll_id</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='rparen'>)</span>
      
      <span class='ivar'>@roll</span> <span class='op'>=</span> <span class='const'>Roll</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_roll_id'>roll_id</span><span class='rparen'>)</span>
      
    <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:public_roll</span><span class='rbracket'>]</span> <span class='kw'>or</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:heart_roll</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:user_id</span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='kw'>or</span> <span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_find_by_nickname'>find_by_nickname</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:user_id</span><span class='rbracket'>]</span><span class='rparen'>)</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:public_roll</span><span class='rbracket'>]</span>
          <span class='ivar'>@roll</span> <span class='op'>=</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_public_roll'>public_roll</span>
        <span class='kw'>elsif</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:heart_roll</span><span class='rbracket'>]</span>
          <span class='ivar'>@roll</span> <span class='op'>=</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_upvoted_roll'>upvoted_roll</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    
    <span class='kw'>if</span> <span class='ivar'>@roll</span> <span class='kw'>and</span> <span class='ivar'>@roll</span><span class='period'>.</span><span class='id identifier rubyid_viewable_by?'>viewable_by?</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='rparen'>)</span>
      <span class='ivar'>@include_frame_children</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:include_children</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>true</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>?</span> <span class='kw'>true</span> <span class='op'>:</span> <span class='kw'>false</span>
      <span class='comment'># lets the view show appropriate information, eg thumbnail_url
</span>      <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:heart_roll</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_user_signed_in?'>user_signed_in?</span> <span class='kw'>and</span> <span class='ivar'>@roll</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span> <span class='op'>==</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_upvoted_roll_id'>upvoted_roll_id</span><span class='rparen'>)</span>

 
      <span class='comment'># the default sort order for genius rolls is by the order field, other rolls score field
</span>      <span class='comment'># if needed in the future, can add a parameter so clients can specify sorting type
</span>      <span class='kw'>if</span> <span class='ivar'>@roll</span><span class='period'>.</span><span class='id identifier rubyid_genius'>genius</span>
        <span class='id identifier rubyid_sort_by'>sort_by</span> <span class='op'>=</span> <span class='symbol'>:order</span><span class='period'>.</span><span class='id identifier rubyid_desc'>desc</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_sort_by'>sort_by</span> <span class='op'>=</span> <span class='symbol'>:score</span><span class='period'>.</span><span class='id identifier rubyid_desc'>desc</span>
      <span class='kw'>end</span>

      <span class='id identifier rubyid_where_hash'>where_hash</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:roll_id</span> <span class='op'>=&gt;</span> <span class='ivar'>@roll</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span> <span class='rbrace'>}</span>
 
      <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:since_id</span><span class='rbracket'>]</span>
        
        <span class='kw'>return</span> <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>please specify a valid since_id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='lparen'>(</span><span class='id identifier rubyid_since_id'>since_id</span> <span class='op'>=</span> <span class='id identifier rubyid_ensure_valid_bson_id'>ensure_valid_bson_id</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:since_id</span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='lparen'>(</span><span class='id identifier rubyid_since_id_frame'>since_id_frame</span> <span class='op'>=</span> <span class='const'>Frame</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_since_id'>since_id</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='rparen'>)</span>
        
        <span class='kw'>case</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:order</span><span class='rbracket'>]</span>
        <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>1</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>forward</span><span class='tstring_end'>&quot;</span></span>
          <span class='kw'>if</span> <span class='ivar'>@roll</span><span class='period'>.</span><span class='id identifier rubyid_genius'>genius</span>
            <span class='id identifier rubyid_where_hash'>where_hash</span><span class='lbracket'>[</span><span class='symbol'>:order</span><span class='period'>.</span><span class='id identifier rubyid_lte'>lte</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_since_id_frame'>since_id_frame</span><span class='period'>.</span><span class='id identifier rubyid_order'>order</span> 
          <span class='kw'>else</span>
            <span class='id identifier rubyid_where_hash'>where_hash</span><span class='lbracket'>[</span><span class='symbol'>:score</span><span class='period'>.</span><span class='id identifier rubyid_lte'>lte</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_since_id_frame'>since_id_frame</span><span class='period'>.</span><span class='id identifier rubyid_score'>score</span>
          <span class='kw'>end</span>
        <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-1</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>reverse</span><span class='tstring_end'>&quot;</span></span>
          <span class='kw'>if</span> <span class='ivar'>@roll</span><span class='period'>.</span><span class='id identifier rubyid_genius'>genius</span>
            <span class='id identifier rubyid_where_hash'>where_hash</span><span class='lbracket'>[</span><span class='symbol'>:order</span><span class='period'>.</span><span class='id identifier rubyid_gte'>gte</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_since_id_frame'>since_id_frame</span><span class='period'>.</span><span class='id identifier rubyid_order'>order</span> 
          <span class='kw'>else</span>
            <span class='id identifier rubyid_where_hash'>where_hash</span><span class='lbracket'>[</span><span class='symbol'>:score</span><span class='period'>.</span><span class='id identifier rubyid_gte'>gte</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_since_id_frame'>since_id_frame</span><span class='period'>.</span><span class='id identifier rubyid_score'>score</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>

      <span class='ivar'>@frames</span> <span class='op'>=</span> <span class='const'>Frame</span><span class='period'>.</span><span class='id identifier rubyid_sort'>sort</span><span class='lparen'>(</span><span class='id identifier rubyid_sort_by'>sort_by</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_limit'>limit</span><span class='lparen'>(</span><span class='ivar'>@limit</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_skip'>skip</span><span class='lparen'>(</span><span class='id identifier rubyid_skip'>skip</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='id identifier rubyid_where_hash'>where_hash</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_all'>all</span>
      
      <span class='kw'>if</span> <span class='ivar'>@frames</span>
        <span class='comment'>#########
</span>        <span class='comment'># solving the N+1 problem with eager loading all children of a frame
</span>        <span class='ivar'>@entries_roll_ids</span> <span class='op'>=</span> <span class='ivar'>@frames</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_f'>f</span><span class='op'>|</span> <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_roll_id'>roll_id</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span>
        <span class='ivar'>@entries_creator_ids</span> <span class='op'>=</span> <span class='ivar'>@frames</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_f'>f</span><span class='op'>|</span> <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_creator_id'>creator_id</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span>
        <span class='ivar'>@entries_hearted_ids</span> <span class='op'>=</span> <span class='ivar'>@frames</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_f'>f</span><span class='op'>|</span> <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_upvoters'>upvoters</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span>
        <span class='ivar'>@entries_conversation_ids</span> <span class='op'>=</span> <span class='ivar'>@frames</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_f'>f</span><span class='op'>|</span> <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_conversation_id'>conversation_id</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span>
        <span class='ivar'>@entries_video_ids</span> <span class='op'>=</span> <span class='ivar'>@frames</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_f'>f</span><span class='op'>|</span> <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_video_id'>video_id</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span>

        <span class='ivar'>@rolls</span> <span class='op'>=</span> <span class='const'>Roll</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='ivar'>@entries_roll_ids</span><span class='rparen'>)</span>
        <span class='ivar'>@users</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='lparen'>(</span><span class='ivar'>@entries_creator_ids</span> <span class='op'>+</span> <span class='ivar'>@entries_hearted_ids</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span><span class='rparen'>)</span>
        <span class='ivar'>@videos</span> <span class='op'>=</span> <span class='const'>Video</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='ivar'>@entries_video_ids</span><span class='rparen'>)</span>
        <span class='ivar'>@conversations</span> <span class='op'>=</span> <span class='const'>Conversation</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='ivar'>@entries_conversation_ids</span><span class='rparen'>)</span>
        <span class='comment'>##########
</span>      <span class='kw'>end</span>        
      <span class='ivar'>@status</span> <span class='op'>=</span>  <span class='int'>200</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>could not find that roll</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="share-instance_method">
  
    - (<tt>Object</tt>) <strong>share</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Returns success if frame is shared successfully, with the given parameters.</p>
<dl class="rdoc-list"><dt>GET</dt>
<dd>
<p>/v1/frame/:frame_id/share</p>
</dd></dl>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>frame_id</span>
      
      
        <span class='type'>(<tt>Required</tt>, <tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The id of the frame to share</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>destination</span>
      
      
        <span class='type'>(<tt>Required</tt>, <tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Where the frame is being shared to (comma seperated list ok)</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>text</span>
      
      
        <span class='type'>(<tt>Required</tt>, <tt>Escaped String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>What the status update of the post is</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/v1/frame_controller.rb', line 232</span>

<span class='kw'>def</span> <span class='id identifier rubyid_share'>share</span>
  <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_client'>client</span><span class='period'>.</span><span class='id identifier rubyid_time'>time</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_api'>api</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>frame</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>share</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>destination</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>text</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>return</span>  <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>a destination and text is required to post</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> 
    <span class='kw'>end</span>
    
    <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:destination</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span>
      <span class='kw'>return</span>  <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>destination must be an array of strings</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> 
    <span class='kw'>end</span>
    
    <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:frame_id</span><span class='rbracket'>]</span>
      
      <span class='kw'>return</span> <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>please specify a valid id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='lparen'>(</span><span class='id identifier rubyid_frame_id'>frame_id</span> <span class='op'>=</span> <span class='id identifier rubyid_ensure_valid_bson_id'>ensure_valid_bson_id</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:frame_id</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='rparen'>)</span>
       
      <span class='id identifier rubyid_frame'>frame</span> <span class='op'>=</span> <span class='const'>Frame</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_frame_id'>frame_id</span><span class='rparen'>)</span>
      <span class='comment'># truncate text so that our link can fit fo sure
</span>      <span class='id identifier rubyid_text'>text</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:text</span><span class='rbracket'>]</span>
      
      <span class='comment'># params[:destination] is an array of destinations, 
</span>      <span class='comment'>#  short_links will be a hash of desinations/links
</span>      <span class='id identifier rubyid_short_links'>short_links</span> <span class='op'>=</span> <span class='const'>GT</span><span class='op'>::</span><span class='const'>LinkShortener</span><span class='period'>.</span><span class='id identifier rubyid_get_or_create_shortlinks'>get_or_create_shortlinks</span><span class='lparen'>(</span><span class='id identifier rubyid_frame'>frame</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:destination</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>,</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='rparen'>)</span>
      
      <span class='id identifier rubyid_resp'>resp</span> <span class='op'>=</span> <span class='kw'>true</span>
      
      <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:destination</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_d'>d</span><span class='op'>|</span>
        <span class='kw'>case</span> <span class='id identifier rubyid_d'>d</span>
        <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>twitter</span><span class='tstring_end'>'</span></span>
          <span class='id identifier rubyid_t'>t</span> <span class='op'>=</span> <span class='const'>GT</span><span class='op'>::</span><span class='const'>SocialPostFormatter</span><span class='period'>.</span><span class='id identifier rubyid_format_for_twitter'>format_for_twitter</span><span class='lparen'>(</span><span class='id identifier rubyid_text'>text</span><span class='comma'>,</span> <span class='id identifier rubyid_short_links'>short_links</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_resp'>resp</span> <span class='op'>&amp;=</span> <span class='const'>GT</span><span class='op'>::</span><span class='const'>SocialPoster</span><span class='period'>.</span><span class='id identifier rubyid_post_to_twitter'>post_to_twitter</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='comma'>,</span> <span class='id identifier rubyid_t'>t</span><span class='rparen'>)</span>
        <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>facebook</span><span class='tstring_end'>'</span></span>
          <span class='id identifier rubyid_t'>t</span> <span class='op'>=</span> <span class='const'>GT</span><span class='op'>::</span><span class='const'>SocialPostFormatter</span><span class='period'>.</span><span class='id identifier rubyid_format_for_facebook'>format_for_facebook</span><span class='lparen'>(</span><span class='id identifier rubyid_text'>text</span><span class='comma'>,</span> <span class='id identifier rubyid_short_links'>short_links</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_resp'>resp</span> <span class='op'>&amp;=</span> <span class='const'>GT</span><span class='op'>::</span><span class='const'>SocialPoster</span><span class='period'>.</span><span class='id identifier rubyid_post_to_facebook'>post_to_facebook</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='comma'>,</span> <span class='id identifier rubyid_t'>t</span><span class='comma'>,</span> <span class='id identifier rubyid_frame'>frame</span><span class='rparen'>)</span>
        <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>email</span><span class='tstring_end'>'</span></span>
          <span class='comment'>#NB if frame is on a private roll, this is a private roll invite.  Otherwise, it's just a Frame share
</span>          <span class='id identifier rubyid_email_addresses'>email_addresses</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:addresses</span><span class='rbracket'>]</span>
          <span class='kw'>return</span> <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>you must provide addresses</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_email_addresses'>email_addresses</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
          
          <span class='id identifier rubyid_resp'>resp</span> <span class='op'>&amp;=</span> <span class='const'>GT</span><span class='op'>::</span><span class='const'>SocialPoster</span><span class='period'>.</span><span class='id identifier rubyid_post_to_email'>post_to_email</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:addresses</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_text'>text</span><span class='comma'>,</span> <span class='id identifier rubyid_frame'>frame</span><span class='rparen'>)</span>
        <span class='kw'>else</span>
          <span class='kw'>return</span> <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>we dont support that destination yet :(</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
        <span class='kw'>end</span>
        <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_increment'>increment</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_frame'>frame</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>share</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_d'>d</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>frame_share</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      
      <span class='kw'>if</span> <span class='id identifier rubyid_resp'>resp</span>
        <span class='ivar'>@status</span> <span class='op'>=</span> <span class='int'>200</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>that user cant post to that destination</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      
    <span class='kw'>else</span>
      <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>could not find that frame</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="show-instance_method">
  
    - (<tt>Object</tt>) <strong>show</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Returns one frame</p>

<pre class="code ruby"><code><span class='const'>AUTHENTICATION</span> <span class='const'>OPTIONAL</span></code></pre>
<dl class="rdoc-list"><dt>GET</dt>
<dd>
<p>/v1/frame/:id</p>
</dd></dl>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>id</span>
      
      
        <span class='type'>(<tt>Required</tt>, <tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The id of the frame</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>include_children</span>
      
      
        <span class='type'>(<tt>Optional</tt>, <tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Include the referenced roll, video, conv, and rerolls</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/v1/frame_controller.rb', line 113</span>

<span class='kw'>def</span> <span class='id identifier rubyid_show'>show</span>
  <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_time'>time</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_api'>api</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>frame</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>show</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>please specify a valid id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='lparen'>(</span><span class='id identifier rubyid_frame_id'>frame_id</span> <span class='op'>=</span> <span class='id identifier rubyid_ensure_valid_bson_id'>ensure_valid_bson_id</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='rparen'>)</span>
      
      <span class='ivar'>@frame</span> <span class='op'>=</span> <span class='const'>Frame</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_frame_id'>frame_id</span><span class='rparen'>)</span>
      <span class='comment'>#N.B. If frame has a roll, check permissions.  If not, it has to be on your dashboard.  Checking for that is expensive b/c we don't index that way.
</span>      <span class='comment'># But guessing a frame is very difficult and noticeable as hacking, so we can fairly safely just return the Frame.
</span>      <span class='kw'>if</span> <span class='ivar'>@frame</span> 
        <span class='comment'># make sure the frame has a roll so this doesn't get all 'so i married an axe murderer' on the consumer.
</span>        <span class='id identifier rubyid_frame_viewable_by'>frame_viewable_by</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='ivar'>@frame</span><span class='period'>.</span><span class='id identifier rubyid_roll'>roll</span> <span class='kw'>and</span> <span class='ivar'>@frame</span><span class='period'>.</span><span class='id identifier rubyid_roll'>roll</span><span class='period'>.</span><span class='id identifier rubyid_viewable_by?'>viewable_by?</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='rparen'>)</span><span class='rparen'>)</span>
        <span class='kw'>if</span> <span class='lparen'>(</span><span class='ivar'>@frame</span><span class='period'>.</span><span class='id identifier rubyid_roll_id'>roll_id</span> <span class='op'>==</span> <span class='kw'>nil</span> <span class='kw'>or</span> <span class='id identifier rubyid_frame_viewable_by'>frame_viewable_by</span><span class='rparen'>)</span>
          <span class='ivar'>@status</span> <span class='op'>=</span>  <span class='int'>200</span>
          <span class='ivar'>@include_frame_children</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:include_children</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>true</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>?</span> <span class='kw'>true</span> <span class='op'>:</span> <span class='kw'>false</span>
        <span class='kw'>else</span>
          <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>that frame isn't viewable or has a bad roll</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>could not find that frame</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>must supply an id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="upvote-instance_method">
  
    - (<tt>Object</tt>) <strong>upvote</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Upvotes a frame and returns the frame back w new score</p>

<pre class="code ruby"><code><span class='const'>REQUIRES</span> <span class='const'>AUTHENTICATION</span></code></pre>
<dl class="rdoc-list"><dt>POST</dt>
<dd>
<p>/v1/frame/:frame_id/upvote</p>
</dd></dl>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>id</span>
      
      
        <span class='type'>(<tt>Required</tt>, <tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The id of the frame</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/v1/frame_controller.rb', line 295</span>

<span class='kw'>def</span> <span class='id identifier rubyid_upvote'>upvote</span>
  <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_time'>time</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_api'>api</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>frame</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>upvote</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:frame_id</span><span class='rbracket'>]</span>
      
      <span class='kw'>return</span> <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>please specify a valid id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='lparen'>(</span><span class='id identifier rubyid_frame_id'>frame_id</span> <span class='op'>=</span> <span class='id identifier rubyid_ensure_valid_bson_id'>ensure_valid_bson_id</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:frame_id</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='rparen'>)</span>
      
      <span class='kw'>if</span> <span class='ivar'>@frame</span> <span class='op'>=</span> <span class='const'>Frame</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_frame_id'>frame_id</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='ivar'>@frame</span><span class='period'>.</span><span class='id identifier rubyid_upvote!'>upvote!</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='rparen'>)</span>
        <span class='ivar'>@status</span> <span class='op'>=</span> <span class='int'>200</span>
        <span class='const'>GT</span><span class='op'>::</span><span class='const'>UserActionManager</span><span class='period'>.</span><span class='id identifier rubyid_upvote!'>upvote!</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='ivar'>@frame</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
        <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_increment'>increment</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_frame'>frame</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>upvote</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>frame_upvote</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='rparen'>)</span>
        <span class='ivar'>@frame</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>could not find frame</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>please specify an id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="watched-instance_method">
  
    - (<tt>Object</tt>) <strong>watched</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>For logged in user, update their viewed_roll and view_count on Frame and
Video (once per 24 hours per user) For logged in and non-logged in user,
create a UserAction to track this portion of viewing.</p>

<pre class="code ruby"><code><span class='const'>AUTHENTICATION</span> <span class='const'>OPTIONAL</span></code></pre>
<dl class="rdoc-list"><dt>POST</dt>
<dd>
<p>/v1/frame/:id/watched</p>
</dd></dl>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='name'>id</span>
      
      
        <span class='type'>(<tt>Required</tt>, <tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The id of the frame</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>start_time</span>
      
      
        <span class='type'>(<tt>Optional</tt>, <tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The start_time of the action on the frame</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>end_time</span>
      
      
        <span class='type'>(<tt>Optional</tt>, <tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The end_time of the action on the frame</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/v1/frame_controller.rb', line 349</span>

<span class='kw'>def</span> <span class='id identifier rubyid_watched'>watched</span>
  <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_time'>time</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_api'>api</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>frame</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>watched</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:frame_id</span><span class='rbracket'>]</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>please specify a valid id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='lparen'>(</span><span class='id identifier rubyid_frame_id'>frame_id</span> <span class='op'>=</span> <span class='id identifier rubyid_ensure_valid_bson_id'>ensure_valid_bson_id</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:frame_id</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='rparen'>)</span>
      
      <span class='ivar'>@frame</span> <span class='op'>=</span> <span class='const'>Frame</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_frame_id'>frame_id</span><span class='rparen'>)</span>
      <span class='ivar'>@status</span> <span class='op'>=</span> <span class='int'>200</span>
      
      <span class='comment'>#conditionally count this as a view (once per 24 hours per user)
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_current_user'>current_user</span>
        <span class='ivar'>@new_frame</span> <span class='op'>=</span> <span class='ivar'>@frame</span><span class='period'>.</span><span class='id identifier rubyid_view!'>view!</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span><span class='rparen'>)</span>
        <span class='ivar'>@frame</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span> <span class='comment'># to update view_count
</span>      <span class='kw'>end</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:start_time</span><span class='rbracket'>]</span> <span class='kw'>and</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:end_time</span><span class='rbracket'>]</span>
        <span class='const'>GT</span><span class='op'>::</span><span class='const'>UserActionManager</span><span class='period'>.</span><span class='id identifier rubyid_view!'>view!</span><span class='lparen'>(</span><span class='id identifier rubyid_current_user'>current_user</span> <span class='op'>?</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span> <span class='op'>:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='ivar'>@frame</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:start_time</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:end_time</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='rparen'>)</span>
        <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_increment'>increment</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_frame'>frame</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>watch</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_current_user'>current_user</span> <span class='op'>?</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span> <span class='op'>:</span> <span class='kw'>nil</span> <span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>frame_watch</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_render_error'>render_error</span><span class='lparen'>(</span><span class='int'>404</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>could not find frame</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Tue Jun  5 08:52:26 2012 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.7.5 (ruby-1.9.3).
</div>

  </body>
</html>