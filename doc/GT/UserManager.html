<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: GT::UserManager
  
    &mdash; Documentation by YARD 0.7.5
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '..';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (U)</a> &raquo; 
    <span class='title'><span class='object_link'><a href="../GT.html" title="GT (module)">GT</a></span></span>
     &raquo; 
    <span class="title">UserManager</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a id="class_list_link" href="#">Class List</a>
  
    <a id="method_list_link" href="#">Method List</a>
  
    <a id="file_list_link" href="#">File List</a>
  
</div>
      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: GT::UserManager
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">GT::UserManager</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">lib/gt/user_manager.rb</dd>
  
</dl>
<div class="clear"></div>








  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_new_auth_from_omniauth-class_method" title="add_new_auth_from_omniauth (class method)">+ (Object) <strong>add_new_auth_from_omniauth</strong>(user, omniauth) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Adds a new auth to an existing user.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#convert_faux_user_to_real-class_method" title="convert_faux_user_to_real (class method)">+ (Object) <strong>convert_faux_user_to_real</strong>(user, omniauth) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Handles faux User becoming <b>real</b> User.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#create_new_user_from_omniauth-class_method" title="create_new_user_from_omniauth (class method)">+ (Object) <strong>create_new_user_from_omniauth</strong>(omniauth) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Creates a real User on signup.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#ensure_users_special_rolls-class_method" title="ensure_users_special_rolls (class method)">+ (Object) <strong>ensure_users_special_rolls</strong>(u, save = false) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Make sure a user has public, watch_later, upvoted, and viewed _rolls should
follow just the public roll.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_or_create_faux_user-class_method" title="get_or_create_faux_user (class method)">+ (Object) <strong>get_or_create_faux_user</strong>(nickname, provider, uid, options = {}) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Creates a fake User with an Authentication matching the given network and
user_id.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#start_user_sign_in-class_method" title="start_user_sign_in (class method)">+ (Object) <strong>start_user_sign_in</strong>(user, options) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Things that happen when a user signs in.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#verify_user-class_method" title="verify_user (class method)">+ (Object) <strong>verify_user</strong>(user, provider, uid, oauth_token, oauth_secret = nil) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>If the given oauth credentials don't match the user's authentication,
verify them with the external provider.</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="add_new_auth_from_omniauth-class_method">
  
    + (<tt>Object</tt>) <strong>add_new_auth_from_omniauth</strong>(user, omniauth) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Adds a new auth to an existing user</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/gt/user_manager.rb', line 56</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_add_new_auth_from_omniauth'>add_new_auth_from_omniauth</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_omniauth'>omniauth</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_new_auth'>new_auth</span> <span class='op'>=</span> <span class='const'>GT</span><span class='op'>::</span><span class='const'>AuthenticationBuilder</span><span class='period'>.</span><span class='id identifier rubyid_build_from_omniauth'>build_from_omniauth</span><span class='lparen'>(</span><span class='id identifier rubyid_omniauth'>omniauth</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_authentications'>authentications</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_new_auth'>new_auth</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
    <span class='const'>GT</span><span class='op'>::</span><span class='const'>PredatorManager</span><span class='period'>.</span><span class='id identifier rubyid_initialize_video_processing'>initialize_video_processing</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_new_auth'>new_auth</span><span class='rparen'>)</span>        
    
    <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_increment'>increment</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>add_service</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_new_auth'>new_auth</span><span class='period'>.</span><span class='id identifier rubyid_provider'>provider</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>add_service</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
    
    <span class='kw'>return</span> <span class='id identifier rubyid_user'>user</span>
  <span class='kw'>else</span>
    <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_increment'>increment</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>add_service</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>error</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
            
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[GT::UserManager#add_new_auth_from_omniauth] Failed to save user: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_full_messages'>full_messages</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>,</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='kw'>false</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="convert_faux_user_to_real-class_method">
  
    + (<tt>Object</tt>) <strong>convert_faux_user_to_real</strong>(user, omniauth) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Handles faux User becoming <b>real</b> User</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/gt/user_manager.rb', line 142</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_convert_faux_user_to_real'>convert_faux_user_to_real</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_omniauth'>omniauth</span><span class='rparen'>)</span>
  <span class='comment'># create new auth and drop old auth
</span>  <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_authentications'>authentications</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  
  <span class='id identifier rubyid_new_auth'>new_auth</span> <span class='op'>=</span> <span class='const'>GT</span><span class='op'>::</span><span class='const'>AuthenticationBuilder</span><span class='period'>.</span><span class='id identifier rubyid_build_from_omniauth'>build_from_omniauth</span><span class='lparen'>(</span><span class='id identifier rubyid_omniauth'>omniauth</span><span class='rparen'>)</span>
  
  <span class='const'>GT</span><span class='op'>::</span><span class='const'>AuthenticationBuilder</span><span class='period'>.</span><span class='id identifier rubyid_normalize_user_info'>normalize_user_info</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_new_auth'>new_auth</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_ensure_valid_unique_nickname!'>ensure_valid_unique_nickname!</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_downcase_nickname'>downcase_nickname</span> <span class='op'>=</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_nickname'>nickname</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span>

  <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_authentications'>authentications</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_new_auth'>new_auth</span>

  <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_faux'>faux</span> <span class='op'>=</span> <span class='const'>User</span><span class='op'>::</span><span class='const'>FAUX_STATUS</span><span class='lbracket'>[</span><span class='symbol'>:converted</span><span class='rbracket'>]</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
    <span class='const'>GT</span><span class='op'>::</span><span class='const'>PredatorManager</span><span class='period'>.</span><span class='id identifier rubyid_initialize_video_processing'>initialize_video_processing</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_new_auth'>new_auth</span><span class='rparen'>)</span>
    <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_increment'>increment</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>new</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>converted</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>signup</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_new_auth'>new_auth</span>
  <span class='kw'>else</span>
    <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_increment'>increment</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>new</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>error</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>        
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[GT::UserManager#convert_faux_user_to_real] Failed to save user: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_full_messages'>full_messages</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>,</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="create_new_user_from_omniauth-class_method">
  
    + (<tt>Object</tt>) <strong>create_new_user_from_omniauth</strong>(omniauth) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Creates a real User on signup</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/gt/user_manager.rb', line 14</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_create_new_user_from_omniauth'>create_new_user_from_omniauth</span><span class='lparen'>(</span><span class='id identifier rubyid_omniauth'>omniauth</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_auth'>auth</span> <span class='op'>=</span> <span class='id identifier rubyid_build_new_user_and_auth'>build_new_user_and_auth</span><span class='lparen'>(</span><span class='id identifier rubyid_omniauth'>omniauth</span><span class='rparen'>)</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
    <span class='comment'># Need to ensure special rolls after saving user b/c of the way add_follower works
</span>    <span class='id identifier rubyid_ensure_users_special_rolls'>ensure_users_special_rolls</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='kw'>true</span><span class='rparen'>)</span>
    <span class='comment'>#additional meta-data for faux user public roll
</span>    <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_public_roll'>public_roll</span><span class='period'>.</span><span class='id identifier rubyid_update_attribute'>update_attribute</span><span class='lparen'>(</span><span class='symbol'>:origin_network</span><span class='comma'>,</span> <span class='const'>Roll</span><span class='op'>::</span><span class='const'>SHELBY_USER_PUBLIC_ROLL</span><span class='rparen'>)</span>
    
    <span class='const'>GT</span><span class='op'>::</span><span class='const'>PredatorManager</span><span class='period'>.</span><span class='id identifier rubyid_initialize_video_processing'>initialize_video_processing</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_auth'>auth</span><span class='rparen'>)</span>
    
    <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_increment'>increment</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>new</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>real</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>signup</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
    
    <span class='kw'>return</span> <span class='id identifier rubyid_user'>user</span>
  <span class='kw'>else</span>
    
    <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_increment'>increment</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>new</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>error</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[GT::UserManager#create_new_user_from_omniauth] Failed to create user: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_full_messages'>full_messages</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>,</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='rbrace'>}</span><span class='tstring_content'> / user looks like: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="ensure_users_special_rolls-class_method">
  
    + (<tt>Object</tt>) <strong>ensure_users_special_rolls</strong>(u, save = false) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Make sure a user has public, watch_later, upvoted, and viewed _rolls should
follow just the public roll</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/gt/user_manager.rb', line 168</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_ensure_users_special_rolls'>ensure_users_special_rolls</span><span class='lparen'>(</span><span class='id identifier rubyid_u'>u</span><span class='comma'>,</span> <span class='id identifier rubyid_save'>save</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_build_public_roll_for_user'>build_public_roll_for_user</span><span class='lparen'>(</span><span class='id identifier rubyid_u'>u</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_public_roll'>public_roll</span>
  <span class='comment'># Must save the user (which will persistes the public roll, set that id in user, then persist the user)
</span>  <span class='comment'># b/c add_follower does an atomic push and reloads the roll and user
</span>  <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span> <span class='kw'>if</span> <span class='id identifier rubyid_save'>save</span>
  <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_public_roll'>public_roll</span><span class='period'>.</span><span class='id identifier rubyid_add_follower'>add_follower</span><span class='lparen'>(</span><span class='id identifier rubyid_u'>u</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_save'>save</span> <span class='kw'>and</span> <span class='op'>!</span><span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_following_roll?'>following_roll?</span><span class='lparen'>(</span><span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_public_roll'>public_roll</span><span class='rparen'>)</span>
  
  <span class='id identifier rubyid_build_upvoted_roll_for_user'>build_upvoted_roll_for_user</span><span class='lparen'>(</span><span class='id identifier rubyid_u'>u</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_upvoted_roll'>upvoted_roll</span>
  <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span> <span class='kw'>if</span> <span class='id identifier rubyid_save'>save</span>
  <span class='comment'>#users now follow their upvoted_roll, from the consumer side of the api its known as the heart_roll
</span>  <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_upvoted_roll'>upvoted_roll</span><span class='period'>.</span><span class='id identifier rubyid_add_follower'>add_follower</span><span class='lparen'>(</span><span class='id identifier rubyid_u'>u</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_save'>save</span> <span class='kw'>and</span> <span class='op'>!</span><span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_following_roll?'>following_roll?</span><span class='lparen'>(</span><span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_upvoted_roll'>upvoted_roll</span><span class='rparen'>)</span>
  
  <span class='id identifier rubyid_build_watch_later_roll_for_user'>build_watch_later_roll_for_user</span><span class='lparen'>(</span><span class='id identifier rubyid_u'>u</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_watch_later_roll'>watch_later_roll</span>
  <span class='comment'>#users don't follow their watch_later_roll
</span>  <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_watch_later_roll'>watch_later_roll</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span> <span class='kw'>if</span> <span class='id identifier rubyid_save'>save</span>
        
  <span class='id identifier rubyid_build_viewed_roll_for_user'>build_viewed_roll_for_user</span><span class='lparen'>(</span><span class='id identifier rubyid_u'>u</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_viewed_roll'>viewed_roll</span>
  <span class='comment'>#users don't follow their viewed_roll
</span>  <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_viewed_roll'>viewed_roll</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span> <span class='kw'>if</span> <span class='id identifier rubyid_save'>save</span>
  
  <span class='kw'>if</span> <span class='id identifier rubyid_save'>save</span> <span class='kw'>and</span> <span class='op'>!</span><span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[GT::UserManager#ensure_users_speical_rolls] Failed to save user: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_full_messages'>full_messages</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>,</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="get_or_create_faux_user-class_method">
  
    + (<tt>Object</tt>) <strong>get_or_create_faux_user</strong>(nickname, provider, uid, options = {}) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Creates a fake User with an Authentication matching the given network and
user_id</p>

<p>--arguments-- nickname =&gt; REQUIRED the unclean nickname for this user
provider =&gt; REQUIRED the name of the fucking social network uid =&gt;
REQUIRED the id given to the user by the social network options =&gt;
OPTIONAL accepts:</p>

<pre class="code ruby"><code>:user_thumbnail_url =&gt; will set this on a newly created user, which will propagate to their special rolls as thumbnails</code></pre>

<p>--returns-- a User - which may be an actual User or a faux User - with a
public Roll Or the Errors, if save failed.</p>


  </div>
</div>
<div class="tags">
  
<h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>ArgumentError</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/gt/user_manager.rb', line 86</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_get_or_create_faux_user'>get_or_create_faux_user</span><span class='lparen'>(</span><span class='id identifier rubyid_nickname'>nickname</span><span class='comma'>,</span> <span class='id identifier rubyid_provider'>provider</span><span class='comma'>,</span> <span class='id identifier rubyid_uid'>uid</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>must supply valid nickname</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_nickname'>nickname</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='op'>!</span><span class='id identifier rubyid_nickname'>nickname</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>must supply valid provider</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_provider'>provider</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='op'>!</span><span class='id identifier rubyid_provider'>provider</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>must supply valid uid</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_uid'>uid</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='op'>!</span><span class='id identifier rubyid_uid'>uid</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
  
  <span class='kw'>if</span> <span class='id identifier rubyid_u'>u</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='lparen'>(</span> <span class='symbol'>:conditions</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>authentications.provider</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_provider'>provider</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>authentications.uid</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_uid'>uid</span> <span class='rbrace'>}</span> <span class='rparen'>)</span>
    <span class='id identifier rubyid_ensure_users_special_rolls'>ensure_users_special_rolls</span><span class='lparen'>(</span><span class='id identifier rubyid_u'>u</span><span class='comma'>,</span> <span class='kw'>true</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_update_attributes'>update_attributes</span><span class='lparen'>(</span><span class='symbol'>:user_image</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:user_thumbnail_url</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:user_image_original</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:user_thumbnail_url</span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_user_image'>user_image</span> <span class='op'>==</span> <span class='kw'>nil</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_u'>u</span>
  <span class='kw'>end</span>
  
  <span class='kw'>begin</span>
    <span class='comment'># No user (faux or real) existed, create a faux user...
</span>    <span class='id identifier rubyid_u'>u</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
    <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_server_created_on'>server_created_on</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>GT::UserManager#get_or_create_faux_user/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_nickname'>nickname</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_provider'>provider</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_uid'>uid</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_nickname'>nickname</span> <span class='op'>=</span> <span class='id identifier rubyid_nickname'>nickname</span>
    <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_user_image'>user_image</span> <span class='op'>=</span> <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_user_image_original'>user_image_original</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:user_thumbnail_url</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_faux'>faux</span> <span class='op'>=</span> <span class='const'>User</span><span class='op'>::</span><span class='const'>FAUX_STATUS</span><span class='lbracket'>[</span><span class='symbol'>:true</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_preferences'>preferences</span> <span class='op'>=</span> <span class='const'>Preferences</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_app_progress'>app_progress</span> <span class='op'>=</span> <span class='const'>AppProgress</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='rparen'>)</span>
    <span class='comment'># This Authentication is how the user will be looked up...
</span>    <span class='id identifier rubyid_auth'>auth</span> <span class='op'>=</span> <span class='const'>Authentication</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='symbol'>:provider</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_provider'>provider</span><span class='comma'>,</span> <span class='symbol'>:uid</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_uid'>uid</span><span class='comma'>,</span> <span class='symbol'>:nickname</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_nickname'>nickname</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_authentications'>authentications</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_auth'>auth</span>
  
    <span class='id identifier rubyid_ensure_valid_unique_nickname!'>ensure_valid_unique_nickname!</span><span class='lparen'>(</span><span class='id identifier rubyid_u'>u</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_downcase_nickname'>downcase_nickname</span> <span class='op'>=</span> <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_nickname'>nickname</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span>
  
    <span class='kw'>if</span> <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
      <span class='comment'># Need to ensure special rolls after saving user b/c of the way add_follower works
</span>      <span class='id identifier rubyid_ensure_users_special_rolls'>ensure_users_special_rolls</span><span class='lparen'>(</span><span class='id identifier rubyid_u'>u</span><span class='comma'>,</span> <span class='kw'>true</span><span class='rparen'>)</span>
      <span class='comment'>#additional meta-data for faux user public roll
</span>      <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_public_roll'>public_roll</span><span class='period'>.</span><span class='id identifier rubyid_update_attribute'>update_attribute</span><span class='lparen'>(</span><span class='symbol'>:origin_network</span><span class='comma'>,</span> <span class='id identifier rubyid_provider'>provider</span><span class='rparen'>)</span>
      
      <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_increment'>increment</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>new</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>faux</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_u'>u</span>
    <span class='kw'>else</span>
      <span class='comment'># If this was a timing issue, and User got created after we initially checked, that means the User we want exists now.  See if we can't recover...
</span>      <span class='id identifier rubyid_u2'>u2</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='lparen'>(</span> <span class='symbol'>:conditions</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>authentications.provider</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_provider'>provider</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>authentications.uid</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_uid'>uid</span> <span class='rbrace'>}</span> <span class='rparen'>)</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_u2'>u2</span> <span class='kw'>if</span> <span class='id identifier rubyid_u2'>u2</span>
      
      <span class='const'>StatsManager</span><span class='op'>::</span><span class='const'>StatsD</span><span class='period'>.</span><span class='id identifier rubyid_increment'>increment</span><span class='lparen'>(</span><span class='const'>Settings</span><span class='op'>::</span><span class='const'>StatsConstants</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>new</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>error</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[GT::UserManager#get_or_create_faux_user] Failed to create user: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_full_messages'>full_messages</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>,</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='rbrace'>}</span><span class='tstring_content'> / user looks like: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>return</span> <span class='id identifier rubyid_u'>u</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='const'>Mongo</span><span class='op'>::</span><span class='const'>OperationFailure</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='comment'># If this was a timing issue, and User got created after we initially checked, that means the User we want exists now.  See if we can't recover...
</span>    <span class='const'>EventMachine</span><span class='op'>::</span><span class='const'>Synchrony</span><span class='period'>.</span><span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='int'>1</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='const'>EM</span><span class='period'>.</span><span class='id identifier rubyid_reactor_running?'>reactor_running?</span> <span class='comment'># allow some time for the user get written and sync'd
</span>    <span class='id identifier rubyid_u'>u</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='lparen'>(</span> <span class='symbol'>:conditions</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>authentications.provider</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_provider'>provider</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>authentications.uid</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_uid'>uid</span> <span class='rbrace'>}</span> <span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_u'>u</span> <span class='kw'>if</span> <span class='id identifier rubyid_u'>u</span>
    
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[GT::UserManager#get_or_create_faux_user] rescuing Mongo::OperationFailure </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='rbrace'>}</span><span class='tstring_content'> / ODD: could not find user from </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_provider'>provider</span><span class='rbrace'>}</span><span class='tstring_content'> with id </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_uid'>uid</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="start_user_sign_in-class_method">
  
    + (<tt>Object</tt>) <strong>start_user_sign_in</strong>(user, options) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Things that happen when a user signs in.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/gt/user_manager.rb', line 38</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_start_user_sign_in'>start_user_sign_in</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_omniauth'>omniauth</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:omniauth</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_provider'>provider</span> <span class='op'>=</span> <span class='id identifier rubyid_omniauth'>omniauth</span> <span class='op'>?</span> <span class='id identifier rubyid_omniauth'>omniauth</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>provider</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>:</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:provider</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_uid'>uid</span> <span class='op'>=</span> <span class='id identifier rubyid_omniauth'>omniauth</span> <span class='op'>?</span> <span class='id identifier rubyid_omniauth'>omniauth</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>uid</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>:</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:uid</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_credentials_token'>credentials_token</span> <span class='op'>=</span> <span class='id identifier rubyid_omniauth'>omniauth</span> <span class='op'>?</span> <span class='id identifier rubyid_omniauth'>omniauth</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>credentials</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>token</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>:</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:token</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_credentials_secret'>credentials_secret</span> <span class='op'>=</span> <span class='id identifier rubyid_omniauth'>omniauth</span> <span class='op'>?</span> <span class='id identifier rubyid_omniauth'>omniauth</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>credentials</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>secret</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>:</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:secret</span><span class='rbracket'>]</span>
  
  <span class='const'>GT</span><span class='op'>::</span><span class='const'>AuthenticationBuilder</span><span class='period'>.</span><span class='id identifier rubyid_update_authentication_tokens!'>update_authentication_tokens!</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_provider'>provider</span><span class='comma'>,</span> <span class='id identifier rubyid_uid'>uid</span><span class='comma'>,</span> <span class='id identifier rubyid_credentials_token'>credentials_token</span><span class='comma'>,</span> <span class='id identifier rubyid_credentials_secret'>credentials_secret</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_provider'>provider</span> <span class='kw'>and</span> <span class='id identifier rubyid_uid'>uid</span> <span class='kw'>and</span> <span class='id identifier rubyid_credentials_token'>credentials_token</span>
  
  <span class='id identifier rubyid_update_token_and_permissions'>update_token_and_permissions</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
  
  <span class='id identifier rubyid_ensure_app_progress_created'>ensure_app_progress_created</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='rparen'>)</span>
  
  <span class='comment'># Always remember users, onus is on them to log out
</span>  <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_remember_me!'>remember_me!</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="verify_user-class_method">
  
    + (<tt>Object</tt>) <strong>verify_user</strong>(user, provider, uid, oauth_token, oauth_secret = nil) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>If the given oauth credentials don't match the user's authentication,
verify them with the external provider.  If verified, returns true (does
not update user or sign in).</p>


  </div>
</div>
<div class="tags">
  
<h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>ArgumentError</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/gt/user_manager.rb', line 195</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_verify_user'>verify_user</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_provider'>provider</span><span class='comma'>,</span> <span class='id identifier rubyid_uid'>uid</span><span class='comma'>,</span> <span class='id identifier rubyid_oauth_token'>oauth_token</span><span class='comma'>,</span> <span class='id identifier rubyid_oauth_secret'>oauth_secret</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>must supply valid user</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>User</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>must supply provider</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_provider'>provider</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='op'>!</span><span class='id identifier rubyid_provider'>provider</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>must supply uid</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_uid'>uid</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='op'>!</span><span class='id identifier rubyid_uid'>uid</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>must supply oauth_token</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_oauth_token'>oauth_token</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='op'>!</span><span class='id identifier rubyid_oauth_token'>oauth_token</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
  
  <span class='id identifier rubyid_auth'>auth</span> <span class='op'>=</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_authentication_by_provider_and_uid'>authentication_by_provider_and_uid</span><span class='lparen'>(</span><span class='id identifier rubyid_provider'>provider</span><span class='comma'>,</span> <span class='id identifier rubyid_uid'>uid</span><span class='rparen'>)</span>
  
  <span class='kw'>return</span> <span class='kw'>false</span> <span class='kw'>unless</span> <span class='id identifier rubyid_auth'>auth</span>
  <span class='kw'>return</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_auth'>auth</span><span class='period'>.</span><span class='id identifier rubyid_oauth_token'>oauth_token</span> <span class='op'>==</span> <span class='id identifier rubyid_oauth_token'>oauth_token</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='lparen'>(</span><span class='id identifier rubyid_auth'>auth</span><span class='period'>.</span><span class='id identifier rubyid_oauth_secret'>oauth_secret</span> <span class='op'>==</span> <span class='id identifier rubyid_oauth_secret'>oauth_secret</span><span class='rparen'>)</span>
  
  <span class='comment'># Check if the given token and secret allow us access to the user's secure data...
</span>  <span class='kw'>case</span> <span class='id identifier rubyid_provider'>provider</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>twitter</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>then</span> <span class='kw'>return</span> <span class='id identifier rubyid_verify_users_twitter'>verify_users_twitter</span><span class='lparen'>(</span><span class='id identifier rubyid_auth'>auth</span><span class='comma'>,</span> <span class='id identifier rubyid_oauth_token'>oauth_token</span><span class='comma'>,</span> <span class='id identifier rubyid_oauth_secret'>oauth_secret</span><span class='rparen'>)</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>facebook</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>then</span> <span class='kw'>return</span> <span class='id identifier rubyid_verify_users_facebook'>verify_users_facebook</span><span class='lparen'>(</span><span class='id identifier rubyid_auth'>auth</span><span class='comma'>,</span> <span class='id identifier rubyid_oauth_token'>oauth_token</span><span class='rparen'>)</span>
  <span class='kw'>else</span> <span class='kw'>return</span> <span class='kw'>false</span>
  <span class='kw'>end</span>
  
  <span class='kw'>return</span> <span class='kw'>false</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Tue Jun  5 08:52:25 2012 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.7.5 (ruby-1.9.3).
</div>

  </body>
</html>