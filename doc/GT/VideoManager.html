<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: GT::VideoManager
  
    &mdash; Documentation by YARD 0.7.5
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '..';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (V)</a> &raquo; 
    <span class='title'><span class='object_link'><a href="../GT.html" title="GT (module)">GT</a></span></span>
     &raquo; 
    <span class="title">VideoManager</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a id="class_list_link" href="#">Class List</a>
  
    <a id="method_list_link" href="#">Method List</a>
  
    <a id="file_list_link" href="#">File List</a>
  
</div>
      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: GT::VideoManager
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">GT::VideoManager</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">lib/gt/video_manager.rb</dd>
  
</dl>
<div class="clear"></div>








  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_or_create_videos_for_url-class_method" title="get_or_create_videos_for_url (class method)">+ (Object) <strong>get_or_create_videos_for_url</strong>(url, use_em = false, memcache_client = nil, should_resolve_url = true, check_deep = false, prob = 1) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Given a URL, do everything in our power to return Video(s).</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="get_or_create_videos_for_url-class_method">
  
    + (<tt>Object</tt>) <strong>get_or_create_videos_for_url</strong>(url, use_em = false, memcache_client = nil, should_resolve_url = true, check_deep = false, prob = 1) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Given a URL, do everything in our power to return Video(s). If we already
have Video(s) in our DB for that URL, will return that.  If there is video
there, but we haven't seen it, will create new Video(s) object(s) and
return that.</p>

<p>-- options --</p>

<p>url --- REQUIRED, the url (unclean, unresvoled) where we are looking for
video use_em --- [false] should we use EventMachine for blocking processes?
(allows same code to be used in multiple environments) memcache_client ---
[nil] if memcache is availble, this client should give us access to it</p>

<pre class="code ruby"><code>*** Memcached client should be EventMachine aware if applicable!</code></pre>

<p>should_resolve_url --- [true] should we try to resolve the url?</p>

<pre class="code ruby"><code>When we get URLs assured to be resolved (ie from Twitter entities) we don't try to resolve</code></pre>

<p>-- returns --</p>
<dl class="rdoc-list"><dt>Video</dt>
<dd>
<p>--- and Array of 0 or more Videos, persisted.</p>
</dd></dl>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/gt/video_manager.rb', line 31</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_get_or_create_videos_for_url'>get_or_create_videos_for_url</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='comma'>,</span> <span class='id identifier rubyid_use_em'>use_em</span><span class='op'>=</span><span class='kw'>false</span><span class='comma'>,</span> <span class='id identifier rubyid_memcache_client'>memcache_client</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_should_resolve_url'>should_resolve_url</span><span class='op'>=</span><span class='kw'>true</span><span class='comma'>,</span> <span class='id identifier rubyid_check_deep'>check_deep</span><span class='op'>=</span><span class='kw'>false</span><span class='comma'>,</span> <span class='id identifier rubyid_prob'>prob</span><span class='op'>=</span><span class='int'>1</span><span class='rparen'>)</span>
  <span class='kw'>begin</span>
    <span class='kw'>return</span> <span class='lbrace'>{</span><span class='symbol'>:videos</span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:from_deep</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='rbrace'>}</span> <span class='kw'>unless</span> <span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span> <span class='op'>=</span> <span class='const'>GT</span><span class='op'>::</span><span class='const'>UrlHelper</span><span class='period'>.</span><span class='id identifier rubyid_get_clean_url'>get_clean_url</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span>
    <span class='kw'>return</span> <span class='lbrace'>{</span><span class='symbol'>:videos</span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:from_deep</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='rbrace'>}</span>
  <span class='kw'>end</span>
  
  <span class='comment'># Are we looking at a known provider that has a unique video at this url?
</span>  <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_provider_info'>provider_info</span> <span class='op'>=</span> <span class='const'>GT</span><span class='op'>::</span><span class='const'>UrlHelper</span><span class='period'>.</span><span class='id identifier rubyid_parse_url_for_provider_info'>parse_url_for_provider_info</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_v'>v</span> <span class='op'>=</span> <span class='const'>Video</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='symbol'>:provider_name</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_provider_info'>provider_info</span><span class='lbracket'>[</span><span class='symbol'>:provider_name</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:provider_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_provider_info'>provider_info</span><span class='lbracket'>[</span><span class='symbol'>:provider_id</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
    <span class='kw'>return</span> <span class='lbrace'>{</span><span class='symbol'>:videos</span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='id identifier rubyid_v'>v</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:from_deep</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='rbrace'>}</span> <span class='kw'>if</span> <span class='id identifier rubyid_v'>v</span>
  <span class='kw'>else</span>
    
    <span class='comment'># couldn't determine provider from URL; try resolving it and trying again
</span>    <span class='comment'># (if we did find provider info, just didn't have a Video, no need to resolve and look again)
</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_url'>url</span> <span class='op'>=</span> <span class='const'>GT</span><span class='op'>::</span><span class='const'>UrlHelper</span><span class='period'>.</span><span class='id identifier rubyid_resolve_url'>resolve_url</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='comma'>,</span> <span class='id identifier rubyid_use_em'>use_em</span><span class='comma'>,</span> <span class='id identifier rubyid_memcache_client'>memcache_client</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_should_resolve_url'>should_resolve_url</span>
      <span class='id identifier rubyid_url'>url</span> <span class='op'>=</span> <span class='const'>GT</span><span class='op'>::</span><span class='const'>UrlHelper</span><span class='period'>.</span><span class='id identifier rubyid_post_process_url'>post_process_url</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span>
      <span class='kw'>return</span> <span class='lbrace'>{</span><span class='symbol'>:videos</span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:from_deep</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='rbrace'>}</span>
    <span class='kw'>end</span>
  
    <span class='comment'># Is the new, resolved URL of a known provider that has a unique video at this url?
</span>    <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_provider_info'>provider_info</span> <span class='op'>=</span> <span class='const'>GT</span><span class='op'>::</span><span class='const'>UrlHelper</span><span class='period'>.</span><span class='id identifier rubyid_parse_url_for_provider_info'>parse_url_for_provider_info</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_v'>v</span> <span class='op'>=</span> <span class='const'>Video</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='symbol'>:provider_name</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_provider_info'>provider_info</span><span class='lbracket'>[</span><span class='symbol'>:provider_name</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:provider_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_provider_info'>provider_info</span><span class='lbracket'>[</span><span class='symbol'>:provider_id</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
      <span class='kw'>return</span> <span class='lbrace'>{</span><span class='symbol'>:videos</span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='id identifier rubyid_v'>v</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:from_deep</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='rbrace'>}</span> <span class='kw'>if</span> <span class='id identifier rubyid_v'>v</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'>##### -- -- -- -- &gt;&gt;&gt;
</span>  <span class='comment'># In the future, if we deep-examine pages for video, would have a cross-references DB that we would look at right now
</span>  <span class='comment'># For a given URL, it would return an array of id's for Videos which we could then return
</span>  <span class='comment'>##### -- -- -- -- &gt;&gt;&gt;
</span>  
  <span class='comment'># first check cached
</span>
  <span class='id identifier rubyid_checkcached'>checkcached</span> <span class='op'>=</span> <span class='const'>DeeplinkCache</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='symbol'>:url</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
  
  <span class='kw'>if</span> <span class='id identifier rubyid_checkcached'>checkcached</span> 
    <span class='id identifier rubyid_vid_ids'>vid_ids</span> <span class='op'>=</span> <span class='id identifier rubyid_checkcached'>checkcached</span><span class='lbracket'>[</span><span class='symbol'>:videos</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_deep_videos'>deep_videos</span> <span class='op'>=</span> <span class='const'>Video</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_vid_ids'>vid_ids</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='lbrace'>{</span><span class='symbol'>:videos</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_deep_videos'>deep_videos</span><span class='comma'>,</span> <span class='symbol'>:from_deep</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='comment'># if can't check cache go deep
</span>  
  <span class='kw'>if</span> <span class='id identifier rubyid_check_deep'>check_deep</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_rand'>rand</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_prob'>prob</span>
    <span class='id identifier rubyid_deep_response'>deep_response</span> <span class='op'>=</span> <span class='const'>GT</span><span class='op'>::</span><span class='const'>DeeplinkParser</span><span class='period'>.</span><span class='id identifier rubyid_find_deep_link'>find_deep_link</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_deep_video_ids'>deep_video_ids</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_deep_videos'>deep_videos</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_deep_response'>deep_response</span><span class='lbracket'>[</span><span class='symbol'>:urls</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_deep_url'>deep_url</span><span class='op'>|</span> 
      <span class='id identifier rubyid_deep_video'>deep_video</span> <span class='op'>=</span> <span class='id identifier rubyid_get_or_create_videos_for_url'>get_or_create_videos_for_url</span><span class='lparen'>(</span><span class='id identifier rubyid_deep_url'>deep_url</span><span class='comma'>,</span> <span class='kw'>false</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='symbol'>:videos</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_deep_videos'>deep_videos</span> <span class='op'>+=</span> <span class='id identifier rubyid_deep_video'>deep_video</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_deep_videos'>deep_videos</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_video'>video</span><span class='op'>|</span>
      <span class='id identifier rubyid_deep_video_ids'>deep_video_ids</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_video'>video</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span>
    <span class='kw'>end</span>
    <span class='comment'>#cache
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_deep_response'>deep_response</span><span class='lbracket'>[</span><span class='symbol'>:to_cache</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_cachedlinks'>cachedlinks</span> <span class='op'>=</span> <span class='const'>DeeplinkCache</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
      <span class='id identifier rubyid_cachedlinks'>cachedlinks</span><span class='period'>.</span><span class='id identifier rubyid_url'>url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
      <span class='id identifier rubyid_cachedlinks'>cachedlinks</span><span class='period'>.</span><span class='id identifier rubyid_videos'>videos</span> <span class='op'>=</span> <span class='id identifier rubyid_deep_video_ids'>deep_video_ids</span>
      <span class='id identifier rubyid_cachedlinks'>cachedlinks</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
    <span class='kw'>end</span>
    <span class='comment'>#if haven't found videos yet go to embedly
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_deep_videos'>deep_videos</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>0</span>    
      <span class='kw'>return</span> <span class='lbrace'>{</span><span class='symbol'>:videos</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_deep_videos'>deep_videos</span><span class='comma'>,</span> <span class='symbol'>:from_deep</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rbrace'>}</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  
  <span class='comment'># since there are no deep links, check to see if we can handle the url
</span>  <span class='kw'>unless</span> <span class='const'>GT</span><span class='op'>::</span><span class='const'>UrlHelper</span><span class='period'>.</span><span class='id identifier rubyid_parse_url_for_provider_info'>parse_url_for_provider_info</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='lbrace'>{</span><span class='symbol'>:videos</span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:from_deep</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='rbrace'>}</span>
  <span class='kw'>end</span>
	  <span class='comment'># Still no video...
</span>  <span class='comment'># Examine that URL (via our cache, our service, or external service like embed.ly), looking for video
</span>  <span class='id identifier rubyid_video_hashes'>video_hashes</span> <span class='op'>=</span> <span class='const'>GT</span><span class='op'>::</span><span class='const'>UrlVideoDetector</span><span class='period'>.</span><span class='id identifier rubyid_examine_url_for_video'>examine_url_for_video</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='comma'>,</span> <span class='id identifier rubyid_use_em'>use_em</span><span class='comma'>,</span> <span class='id identifier rubyid_memcache_client'>memcache_client</span><span class='rparen'>)</span>
  
  <span class='comment'># turn that array of hashes into Videos
</span>  <span class='id identifier rubyid_videos'>videos</span> <span class='op'>=</span> <span class='id identifier rubyid_find_or_create_videos_for_hashes'>find_or_create_videos_for_hashes</span><span class='lparen'>(</span><span class='id identifier rubyid_video_hashes'>video_hashes</span><span class='rparen'>)</span>
  
  <span class='comment'># videos will be an Array of 0 or more Videos
</span>  <span class='kw'>return</span> <span class='lbrace'>{</span><span class='symbol'>:videos</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_videos'>videos</span><span class='comma'>,</span> <span class='symbol'>:from_deep</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Tue Jun  5 08:52:25 2012 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.7.5 (ruby-1.9.3).
</div>

  </body>
</html>